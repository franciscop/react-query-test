(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('react-jsdom'), require('react-dom/test-utils')) :
  typeof define === 'function' && define.amd ? define(['react-jsdom', 'react-dom/test-utils'], factory) :
  (global = global || self, global.$ = factory(global.ReactJSDOM, global.testUtils));
}(this, (function (ReactJSDOM, testUtils) { 'use strict';

  ReactJSDOM = ReactJSDOM && ReactJSDOM.hasOwnProperty('default') ? ReactJSDOM['default'] : ReactJSDOM;

  // This takes a react object like <Button /> and returns the DOM tree
  var render = obj => {
    if (!obj) return [];

    // A react instance, so render it to jsdom:
    if (obj.$$typeof) {
      return [ReactJSDOM.render(obj)];
    }

    // It's already parsed
    return (Array.isArray(obj) ? obj : [obj]).filter(
      obj => typeof obj === "object"
    );
  };

  // In React 16.9 - https://github.com/facebook/react/issues/15379

  const $ = function(obj) {
    if (!(this instanceof $)) return new $(obj);
    testUtils.act(() => {
      this.nodes = render(obj);
    });
    return this;
  };

  $.prototype.first = function() {
    return this.nodes[0] || null;
  };

  $.prototype.last = function() {
    return this.nodes[this.nodes.length - 1] || null;
  };

  $.prototype.attr = function(key) {
    const node = this.first();
    return node && node.getAttribute(key);
  };

  $.prototype.html = function() {
    const node = this.first();
    return node ? node.outerHTML : "";
  };

  $.prototype.text = function() {
    const node = this.first();
    return node ? node.textContent : "";
  };

  $.prototype.find = function(selector) {
    if (!selector) return this;
    const nodes = this.nodes
      .map(node => [...node.querySelectorAll(selector)])
      .flatten(); // So nice :)
    return $(nodes);
  };

  $.prototype.map = function(callback) {
    return this.nodes.map(callback);
  };

  $.prototype.trigger = function(type, time = 0) {
    return testUtils.act(async () => {
      this.map(node => node[type]());
      await new Promise(done => setTimeout(done, time));
    });
  };

  $.prototype.click = function(...args) {
    const selector = args.find(a => typeof a === "string");
    const time = args.find(a => typeof a === "number");
    return this.find(selector).trigger("click", time);
  };

  $.prototype.children = function (selector = '') {
    const node = this.first();
    // Return early if possible
    if (!node) return this;
    if (!selector) return node.childNodes;
    // Will proceed only if there is a selector provided
    const children = [];
    node.childNodes.forEach(childNode => {
      if (childNode.matches(selector)) {
        children.push(childNode);
      }
    });
    return children;
  };

  return $;

})));
