import files from "files";
import Handlebars from "handlebars";
import marked from "marked";
import server from "live-server";
const { read, walk, write } = files;
const hbs = (tpl, data = {}) => Handlebars.compile(tpl)(data);

// This is to sort the paths by their depth in the filesystem
const depth = path => (path ? path.replace(/[^\/]/g, "").length : 0);

// This builds the whole site from the readmes, using marked and handlebars
const build = async (req, res, next) => {
  try {
    const content = await walk("../src")
      .filter(/\.md$/)
      .sort((a, b) => a.localeCompare(b))
      .sort((a, b) => depth(a) - depth(b))
      .map(read)
      .map(page => marked(page)) // Because it breaks with 2nd arg as the index
      .join("\n\n");
    const page = await read("./index.hbs");
    const html = hbs(page, { content });
    await write("./index.html", html);
    next();
  } catch (error) {
    next(error);
  }
};

server.start({
  wait: 100,
  root: "./",
  watch: ["./", "../src"],

  // Put here the autogenerated files to avoid infinite loops:
  ignore: ["index.html"],
  middleware: [build]
});
